apiVersion: v1
kind: Namespace
metadata:
  name: {{ .Values.gitea.namespace }}
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: {{ include "app.fullname" . }}-keda
  labels:
    {{- include "app.labels" . | nindent 4 }}
  namespace: argocd
  finalizers:
  - resources-finalizer.argocd.argoproj.io
spec:
  syncPolicy:
    syncOptions:
      - ServerSideApply=true
  destination:
    namespace: {{ .Values.gitea.namespace }}
    server: {{ .Values.spec.destination.server }}
  project: {{ .Values.spec.project }}
  source:
    chart: gitea-charts
    repoURL: https://dl.gitea.com/charts/
    targetRevision: {{ .Values.gitea.version }}
    helm:
      releaseName: gitea
      values: |-
        replicaCount: {{ .Values.gitea.replicas }}

        ingress:
          enabled: true
          className: nginx
          hosts:
            - host: git.yusufali.ca
              paths:
                - path: /
                  pathType: Prefix
          annotations:
            kubernetes.io/ingress.class: nginx
            cert-manager.io/cluster-issuer: letsencrypt-prod
            nginx.ingress.kubernetes.io/ssl-redirect: "true"
            nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
            external-dns.alpha.kubernetes.io/target: "mordorhome.yusufali.ca"
          tls:
            - hosts:
                - "*.yusufali.ca"
              secretName: wildcard-yusufali
        
        resources:
            {{- toYaml .Values.gitea.resources | nindent 12 }}

        deployment:
          env: []

        persistence:
          enabled: true
          storageClass: {{ .Values.gitea.storageClass }}
        
        gitea:
          config:
            DOMAIN: git.yusufali.ca
            ROOT_URL: https://git.yusufali.ca
            DISABLED_REPO_UNITS: repo.issues,repo.wiki,repo.projects,repo.packages,repo.ext_issues,repo.ext_wiki
            DEFAULT_REPO_UNITS: repo.code,repo.releases,repo.pulls,repo.actions
            DISABLE_STARS: true
            
            packages:
              enabled: false
        
        redis-cluster:
          enabled: false
        
        postgresql-ha:
          enabled: false
        
        postgresql:
          enabled: false