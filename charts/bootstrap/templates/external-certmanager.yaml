---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: bootstrap-external-certmanager
  namespace: argocd
spec:
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - ServerSideApply=true
  destination:
    namespace: {{ .Release.Namespace }}
    server: https://kubernetes.default.svc
  project: {{ .Values.project }}
  source:
    chart: cert-manager
    repoURL: https://charts.jetstack.io
    targetRevision: {{ .Values.versions.certmanager }}
    helm:
      releaseName: cert-manager
      values: |-
        extraArgs:
          - --dns01-recursive-nameservers-only
          - --dns01-recursive-nameservers=8.8.8.8:53,1.1.1.1:53
        installCRDs: true
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: cloudflare
spec:
  secretStoreRef:
    name: external-infra
    kind: ClusterSecretStore
  target:
    name: cloudflare
  data:
    - secretKey: CLOUDFLARE_SERVC_DOMAIN_NAME
      remoteRef:
        key: CLOUDFLARE
        property: CLOUDFLARE_SERVC_DOMAIN_NAME
    - secretKey: CLOUDFLARE_PERSONAL_API_KEY
      remoteRef:
        key: CLOUDFLARE
        property: CLOUDFLARE_PERSONAL_API_KEY
    - secretKey: CLOUDFLARE_PERSONAL_DOMAIN_NAME
      remoteRef:
        key: CLOUDFLARE
        property: CLOUDFLARE_PERSONAL_DOMAIN_NAME
---
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: {{ .Values.certmanager.email }}
    privateKeySecretRef:
      name: letsencrypt-prod
    solvers:
      - dns01:
          cloudflare:
            email: {{ .Values.certmanager.email }}
            apiKeySecretRef:
              name: cloudflare
              key: CLOUDFLARE_PERSONAL_API_KEY
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cloudflare-dynamic-dns
  labels:
    app: ddns
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ddns
  template:
    metadata:
      labels:
        app: ddns
    spec:
      containers:
        - name: app
          image: hotio/cloudflareddns
          env:
            - name: CF_USER
              value: {{ .Values.certmanager.email }}
            - name: CF_RECORDTYPES
              value: A
            - name: CF_APIKEY
              valueFrom:
                secretKeyRef:
                  name: cloudflare
                  key: CLOUDFLARE_PERSONAL_API_KEY
            - name: CF_ZONES
              valueFrom:
                secretKeyRef:
                  name: cloudflare
                  key: CLOUDFLARE_PERSONAL_DOMAIN_NAME
            - name: CF_HOSTS
              value: mordorhome.{{ .Values.domains.external }}
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: bootstrap-external-externaldns
  namespace: argocd
spec:
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - ServerSideApply=true
  destination:
    namespace: {{ .Release.Namespace }}
    server: https://kubernetes.default.svc
  project: {{ .Values.project }}
  source:
    chart: external-dns
    repoURL: https://kubernetes-sigs.github.io/external-dns
    targetRevision: {{ .Values.versions.externaldns }}
    helm:
      releaseName: external-dns
      values: |-
        env:
          - name: CF_API_KEY
            valueFrom:
              secretKeyRef:
                name: cloudflare
                key: CLOUDFLARE_PERSONAL_API_KEY
          - name: CF_API_EMAIL
            value: {{ .Values.certmanager.email }}
        
        provider: cloudflare
        domainFilters:
          - {{ .Values.domains.external }}
          - {{ .Values.domains.servc }}
        sources:
          - ingress
        extraArgs:
          - --default-targets=mordorhome.{{ .Values.domains.external }}
          - --managed-record-types=CNAME
